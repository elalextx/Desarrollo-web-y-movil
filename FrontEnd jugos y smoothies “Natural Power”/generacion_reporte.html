<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Power - Reportes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h3>Reporte de ventas</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Periodo</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="tablaReportes">
            </tbody>
        </table>
    </div>

    <script>
        function generarCSV(compras) {
            let csv = "ID,Cliente,Productos,Cantidades,Total,Fecha,Estado\n";
            compras.forEach(c => {
                csv += `${c.id},${c.clienteNombre},"${c.productos.join(";")}","${c.cantidades.join(";")}",${c.total},${c.fecha},${c.estado}\n`;
            });
            return csv;
        }

        function descargarCSV(nombreArchivo, csv) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = nombreArchivo;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const compras = JSON.parse(localStorage.getItem("compras")) || [];
            const tabla = document.getElementById("tablaReportes");

            if (compras.length === 0) {
                tabla.innerHTML = `<tr><td colspan="2" class="text-center">No hay compras registradas</td></tr>`;
                return;
            }

            compras.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            let startDate = new Date(compras[0].fecha);
            const endDate = new Date(compras[compras.length - 1].fecha);
            const periodos = [];

            while (startDate <= endDate) {
                const periodEnd = new Date(startDate);
                periodEnd.setDate(periodEnd.getDate() + 6);
                periodos.push({ start: new Date(startDate), end: new Date(periodEnd) });
                startDate.setDate(startDate.getDate() + 7);
            }

            periodos.forEach(p => {
                const startStr = p.start.toLocaleDateString();
                const endStr = p.end.toLocaleDateString();
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>[${startStr}] - [${endStr}]</td>
                    <td><button class="btn btn-primary btn-sm">Generar reporte</button></td>
                `;
                row.querySelector("button").addEventListener("click", () => {
                    const comprasPeriodo = compras.filter(c => {
                        const fechaCompra = new Date(c.fecha);
                        return fechaCompra >= p.start && fechaCompra <= p.end;
                    });
                    if (comprasPeriodo.length === 0) {
                        alert("No hay compras en este periodo");
                        return;
                    }
                    const csv = generarCSV(comprasPeriodo);
                    descargarCSV(`reporte_${startStr}_a_${endStr}.csv`, csv);
                });
                tabla.appendChild(row);
            });
        });
    </script>
</body>
</html>