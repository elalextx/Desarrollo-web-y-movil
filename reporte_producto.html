<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Power - Ventas por producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h3>Base de datos de ventas</h3>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Nombre del producto:</label>
                <input type="text" id="inputNombre" class="form-control" placeholder="Ingrese nombre del producto">
            </div>
            <div class="col-md-4">
                <label class="form-label">Fecha:</label>
                <input type="date" id="inputFecha" class="form-control">
            </div>
            <div class="col-md-4">
                <label class="form-label">Cliente:</label>
                <input type="text" id="inputCliente" class="form-control" placeholder="Ingrese nombre del cliente">
            </div>
        </div>
        <button id="btnBuscar" class="btn btn-primary mb-3">Buscar</button>

        <table class="table table-bordered" id="resultadosTable" style="display:none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Productos</th>
                    <th>Cantidades</th>
                    <th>Total</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="btnDescargar" class="btn btn-success" style="display:none;">Descargar CSV</button>
    </div>

    <script>
        function generarCSV(compras) {
            let csv = "ID,Cliente,Productos,Cantidades,Total,Fecha,Estado\n";
            compras.forEach(c => {
                csv += `${c.id},"${c.clienteNombre}","${c.productos.join("; ")}","${c.cantidades.join("; ")}",${c.total},${c.fecha},${c.estado}\n`;
            });
            return csv;
        }

        function descargarCSV(nombreArchivo, csv) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = nombreArchivo;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById("btnBuscar").addEventListener("click", () => {
            const nombreProducto = document.getElementById("inputNombre").value.trim().toLowerCase();
            const fechaInput = document.getElementById("inputFecha").value;
            const clienteInput = document.getElementById("inputCliente").value.trim().toLowerCase();

            const compras = JSON.parse(localStorage.getItem("compras")) || [];

            const comprasFiltradas = compras.filter(c => {
                const productoMatch = nombreProducto === "" || c.productos.some(p => p.toLowerCase().includes(nombreProducto));
                const fechaMatch = fechaInput === "" || c.fecha.startsWith(fechaInput);
                const clienteMatch = clienteInput === "" || c.clienteNombre.toLowerCase().includes(clienteInput);
                return productoMatch && fechaMatch && clienteMatch;
            });

            const tbody = document.querySelector("#resultadosTable tbody");
            tbody.innerHTML = "";

            if (comprasFiltradas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">No se encontraron resultados</td></tr>`;
                document.getElementById("resultadosTable").style.display = "table";
                document.getElementById("btnDescargar").style.display = "none";
                return;
            }

            comprasFiltradas.forEach(c => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.clienteNombre}</td>
                    <td>${c.productos.join(", ")}</td>
                    <td>${c.cantidades.join(", ")}</td>
                    <td>$${c.total.toLocaleString()}</td>
                    <td>${c.fecha}</td>
                    <td>${c.estado}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById("resultadosTable").style.display = "table";
            document.getElementById("btnDescargar").style.display = "inline-block";

            document.getElementById("btnDescargar").onclick = () => {
                const csv = generarCSV(comprasFiltradas);
                descargarCSV("reporte_producto.csv", csv);
            };
        });
    </script>
</body>
</html>